<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 1rem;
    }
    h2 {
      text-align: center;
      color: #4CAF50;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .modal-content label {
      display: block;
      margin-top: 10px;
    }
    .modal-content input, .modal-content select, .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .modal-content button {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .modal-content button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h2>äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
  <div id="calendar"></div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="inputModal" class="modal">
    <div class="modal-content">
      <h3>äºˆå®šã‚’å…¥åŠ›</h3>
      <form id="scheduleForm">
        <label>ğŸ‘¤ åå‰</label>
        <input type="text" id="nameInput" required>

        <label>â° æ™‚é–“</label>
        <select id="timeInput">
          <!-- JSã§è¿½åŠ  -->
        </select>

        <label>ğŸ“‹ å†…å®¹</label>
        <textarea id="noteInput" rows="3" required></textarea>

        <button type="submit">âœ… é€ä¿¡ã™ã‚‹</button>
      </form>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

  <script>
    const liffId = '2007439957-pX9R52eq'; // ã‚ãªãŸã®LIFF ID
    const apiUrl = 'https://script.google.com/macros/s/AKfycbxnKaxkaY8x2Yahgzmc44x9RyBe3s7NfT4ESf9JldsgnbctbYal-BXWW0u8ZI4UUFDi/exec';
    let calendar;
    let selectedDate = null;

    async function initLiff() {
      try {
        await liff.init({ liffId });
      } catch (err) {
        alert('LIFFåˆæœŸåŒ–ã«å¤±æ•—: ' + err);
      }
    }

    async function fetchEvents() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        return data.map(e => ({
          title: e.title,
          start: e.start,
          extendedProps: { name: e.name, note: e.note }
        }));
      } catch (err) {
        alert('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—å¤±æ•—: ' + err);
        return [];
      }
    }

    function renderCalendar(events) {
      const el = document.getElementById('calendar');
      const isMobile = window.innerWidth < 600;

      if (calendar) calendar.destroy();

      calendar = new FullCalendar.Calendar(el, {
        initialView: isMobile ? 'listDay' : 'dayGridMonth',
        locale: 'ja',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listDay'
        },
        nowIndicator: true,
        events,
        eventClick: info => {
          const { name, note } = info.event.extendedProps;
          alert(`ğŸ‘¤ åå‰: ${name || 'ä¸æ˜'}\nğŸ“‹ å†…å®¹: ${note || 'ï¼ˆå†…å®¹ãªã—ï¼‰'}\nğŸ•’ æ—¥æ™‚: ${info.event.start.toLocaleString()}`);
        },
        dateClick: info => {
          selectedDate = info.dateStr;
          document.getElementById('inputModal').style.display = 'block';
        }
      });

      calendar.render();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ™‚é–“é¸æŠè‚¢ã‚’ç”Ÿæˆ
    function populateTimeOptions() {
      const select = document.getElementById('timeInput');
      for (let h = 0; h < 24; h++) {
        ['00', '30'].forEach(min => {
          const option = document.createElement('option');
          option.value = `${String(h).padStart(2, '0')}:${min}`;
          option.textContent = option.value;
          select.appendChild(option);
        });
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('scheduleForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('nameInput').value;
      const time = document.getElementById('timeInput').value;
      const note = document.getElementById('noteInput').value;

      const datetime = new Date(`${selectedDate}T${time}`);
      const formatted = datetime.toLocaleString('ja-JP', { dateStyle: 'medium', timeStyle: 'short' });

      const message =
        `ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰äºˆå®šè¿½åŠ \n\n` +
        `ğŸ‘¤ åå‰: ${name}\n` +
        `ğŸ•’ æ—¥æ™‚: ${formatted}\n` +
        `ğŸ“‹ å†…å®¹: ${note}`;

      try {
        await liff.sendMessages([{ type: 'text', text: message }]);
        alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
        document.getElementById('inputModal').style.display = 'none';
        e.target.reset();

        // GASé€£æºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹ã«
        // await fetch(apiUrl, {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ name, note, start: datetime.toISOString() })
        // });

        const updated = await fetchEvents();
        renderCalendar(updated);
      } catch (err) {
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ\n" + err);
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = e => {
      if (e.target === document.getElementById('inputModal')) {
        document.getElementById('inputModal').style.display = 'none';
      }
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await initLiff();
      populateTimeOptions();
      const events = await fetchEvents();
      renderCalendar(events);
    });
  </script>
</body>
</html>
